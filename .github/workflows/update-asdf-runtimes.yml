name: Update ASDF Runtimes

on:
  schedule:
    # Monthly on the 1st at 9am UTC
    - cron: '0 9 1 * *'
  workflow_dispatch: # Manual trigger for testing

jobs:
  update-runtimes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Update ASDF Runtimes
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          base_branch: "main"
          branch_prefix: "claude/"

          settings: |
            {
              "env": {
                "GH_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
              },
              "allowedCommands": [
                "Bash(git checkout:*)",
                "Bash(git add:*)",
                "Bash(git commit:*)",
                "Bash(git push:*)",
                "Bash(git branch:*)",
                "Bash(gh pr create:*)",
                "Bash(gh pr view:*)"
              ]
            }

          prompt: |
            # Monthly ASDF Runtime Version Update

            Your task is to check for updates to the runtimes specified in `apps/asdf/.tool-versions`
            and create a PR with appropriate updates.

            ## Step 1: Read Current Versions

            Read `apps/asdf/.tool-versions` to get the current runtime versions.

            ## Step 2: Fetch Latest Version Data

            For each runtime (nodejs, python, ruby), fetch version information from endoflife.date:
            - https://endoflife.date/api/nodejs.json
            - https://endoflife.date/api/python.json
            - https://endoflife.date/api/ruby.json

            This API provides release dates, EOL dates, LTS status, and support phases.

            ## Step 3: Apply Version Update Policy

            For each runtime, determine if an update is appropriate using these rules:

            ### Patch Updates (x.y.Z → x.y.Z+n)
            - **Action**: ALWAYS update
            - **Rationale**: Bug fixes and security patches only, no API changes
            - **Wait period**: None required

            ### Minor Updates (x.Y.z → x.Y+n.z)
            - **Action**: Update if the new version has been out for at least 2 weeks
            - **Rationale**: New features but backward compatible; brief wait lets early adopters surface issues
            - **Check**: Compare release date to today's date

            ### Major Updates (X.y.z → X+n.y.z)
            - **Action**: Only update if ALL of the following are true:

            **For Node.js:**
            - The new major version is in LTS or Active LTS phase (endoflife.date shows `lts` field)
            - At least 6 months since initial release of this major version
            - Prefer even-numbered versions (they become LTS)

            **For Python:**
            - At least 6 months since x.0.0 release
            - At least 2 patch releases exist (e.g., 3.13.2+ means 3.13 is stabilizing)
            - The version is not in pre-release (no alpha/beta/rc)

            **For Ruby:**
            - At least 6 months since x.0.0 release
            - At least 1 patch release exists (stability signal)
            - Check if it's a "Christmas release" - Ruby releases major versions on Dec 25

            ### Version Selection Priority
            1. For Node.js: Prefer the current LTS version over the latest
            2. For Python/Ruby: Prefer the latest stable (non-prerelease) version

            ## Step 4: Generate Recommendations

            For each runtime, document your reasoning:
            ```
            ## [runtime] Current: x.y.z → Recommended: a.b.c

            **Update type**: patch/minor/major
            **Decision**: UPDATE / SKIP
            **Reasoning**: [specific rationale based on above rules]
            ```

            If no updates are recommended, create a brief summary and exit without creating a PR.

            ## Step 5: Create PR (if updates exist)

            If any updates are recommended:

            1. Create a new branch: `claude/update-asdf-runtimes-YYYY-MM`
            2. Update `apps/asdf/.tool-versions` with the new versions
            3. Create a PR with:
               - Title: `chore(asdf): update runtime versions`
               - Body containing:
                 - Summary of changes
                 - Detailed reasoning for each update (from Step 4)
                 - Links to relevant release notes
                 - Any migration notes if major version bumps

            ## Important Notes

            - Be CONSERVATIVE: When in doubt, don't update. Stability > bleeding edge.
            - For major versions, the 6-month rule is a MINIMUM, not a target.
            - If endoflife.date shows a version is in "security" phase (only security fixes), prefer a newer actively maintained version.
            - Current date for calculations: Use the current date from your context.

          claude_args: >-
            --allowed-tools "
            Bash(git:*),
            Bash(gh:*),
            Read(**),
            Edit(**),
            Write(**),
            Glob(**),
            Grep(**),
            WebFetch,
            TodoWrite
            "
            --model sonnet
