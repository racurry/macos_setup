---
name: Auto-Rebase PRs

on:
  push:
    branches: ["main"]

concurrency:
  group: auto-rebase
  cancel-in-progress: true

jobs:
  auto-rebase:
    name: Auto-rebase open PRs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get open PRs
        id: get-prs
        run: |
          # Get all open PRs targeting main branch (tab-separated for safe parsing)
          prs=$(gh pr list --base main --state open \
            --json number,headRefName \
            --jq '.[] | "\(.number)\t\(.headRefName)"')
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$prs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PRS: ${{ steps.get-prs.outputs.prs }}
        run: |
          # Initialize summary
          echo "## Auto-Rebase Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| PR | Branch | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|---|" >> "$GITHUB_STEP_SUMMARY"

          # Helper to log to both stdout and summary
          log_result() {
            local pr="$1" branch="$2" status="$3"
            echo "  → PR #$pr ($branch): $status"
            echo "| #$pr | \`$branch\` | $status |" >> "$GITHUB_STEP_SUMMARY"
          }

          if [ -z "$PRS" ]; then
            echo "No open PRs found targeting main branch"
            echo "| - | - | No open PRs found |" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "$PRS" | while IFS=$'\t' read -r pr_number branch_name; do
            if [ -z "$pr_number" ] || [ -z "$branch_name" ]; then
              continue
            fi

            echo "Processing PR #$pr_number ($branch_name)"

            # Fetch only the specific branch (main already fetched by checkout)
            if ! git fetch origin "$branch_name"; then
              echo "::warning::Failed to fetch branch $branch_name for PR #$pr_number"
              log_result "$pr_number" "$branch_name" "⚠️ Fetch failed"
              continue
            fi

            # Check if rebase is needed
            merge_base=$(git merge-base origin/main "origin/$branch_name")
            main_head=$(git rev-parse origin/main)

            if [ "$merge_base" = "$main_head" ]; then
              log_result "$pr_number" "$branch_name" "✅ Already up to date"
              continue
            fi

            # Checkout the PR branch
            git checkout -B "$branch_name" "origin/$branch_name"

            # Attempt rebase
            if git rebase origin/main; then
              echo "Successfully rebased PR #$pr_number"

              # Push the rebased branch
              if git push origin "$branch_name" --force-with-lease; then
                log_result "$pr_number" "$branch_name" "✅ Rebased and pushed"
              else
                echo "::warning::Push failed for PR #$pr_number - may need manual retry"
                log_result "$pr_number" "$branch_name" "⚠️ Rebase ok, push failed"
              fi

            else
              echo "Rebase failed for PR #$pr_number due to conflicts"

              # Capture conflicting files before aborting
              conflicting_files=$(git diff --name-only --diff-filter=U 2>/dev/null | head -10)

              # Abort the rebase
              git rebase --abort

              # Check if we already have a pending @claude rebase comment (avoid spam)
              existing_comment=$(gh pr view "$pr_number" --json comments \
                --jq '.comments | map(select(.author.login == "github-actions" and (.body | contains("@claude") and contains("rebase")))) | length')

              if [ "$existing_comment" -gt 0 ]; then
                echo "  Skipping comment - already has pending @claude rebase request"
                log_result "$pr_number" "$branch_name" "❌ Conflicts (comment already pending)"
              else
                # Build detailed conflict message for Claude using heredoc
                if [ -n "$conflicting_files" ]; then
                  gh pr comment "$pr_number" --body "$(cat <<EOF
          @claude Please rebase this PR onto main and resolve any conflicts.

          Conflicting files:
          \`\`\`
          $conflicting_files
          \`\`\`

          Preserve the intent of this PR's changes when resolving conflicts.
          EOF
          )"
                else
                  gh pr comment "$pr_number" --body "@claude Please rebase this PR onto main and resolve any conflicts. Preserve the intent of this PR's changes."
                fi
                log_result "$pr_number" "$branch_name" "❌ Conflicts - Claude notified"
              fi
            fi

            # Return to main branch
            git checkout main
          done

          echo ""
          echo "Done processing all PRs."
