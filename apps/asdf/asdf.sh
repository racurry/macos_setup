#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/bash/common.sh
source "${SCRIPT_DIR}/../../lib/bash/common.sh"

show_help() {
    cat << EOF
Usage: $0 [COMMAND]

Manage asdf plugins and runtime installations.

Commands:
    setup       Run full setup (add plugins, install runtimes)
    help        Show this help message (also: -h, --help)
EOF
}

add_plugins() {
    print_heading "Add asdf plugins"

    require_command asdf

    # Get plugin list from asdf's current command (relies on asdf finding .tool-versions)
    plugin_list=$(asdf current --no-header 2>/dev/null | awk '{print $1}' || true)
    if [[ -z "${plugin_list}" ]]; then
        log_info "No tools configured for asdf"
        return 0
    fi

    while IFS= read -r plugin; do
        [[ -n "${plugin}" ]] || continue
        log_info "Adding '${plugin}'"
        asdf plugin add "${plugin}"
    done <<< "${plugin_list}"
}

install_runtimes() {
    print_heading "Install asdf runtimes"

    require_command asdf

    log_info "Running 'asdf install'"
    unset ASDF_RUBY_VERSION ASDF_NODEJS_VERSION ASDF_PYTHON_VERSION
    asdf install
}

do_setup() {
    add_plugins
    install_runtimes
}

main() {
    local command=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            setup)
                command="setup"
                shift
                ;;
            help|--help|-h)
                show_help
                exit 0
                ;;
            *)
                fail "Unknown argument '${1}'. Run '$0 help' for usage."
                ;;
        esac
    done

    case "${command}" in
        setup)
            do_setup
            ;;
        "")
            show_help
            exit 0
            ;;
    esac
}

main "$@"