#!/usr/bin/env ruby

require 'json'
require_relative '../lib/terminal_helpers.rb'

SHELL_APPS_FILE = 'data/install_shell_apps.json'

def install_shell_app(name:, test:, command:)
  initial_text = "#{name}..."
  pprint initial_text, indent: 1, style: :bold

  if system("#{test} > /dev/null 2>&1")
    final_text = "Already installed! "
    text_opts = { style: :italic }
    emoji = "üÜó"
  elsif system(command)
    final_text = "Successfully installed!"
    text_opts = { style: :bold, color: :green }
    emoji = "‚úÖ"
  else
    final_text = "Something went wrong!"
    text_opts = { style: :bold, color: :red }
    emoji = "‚õî"
  end

  print_column_fill final_text + emoji + initial_text, indent: 1
  pprint final_text, text_opts
  puts emoji
end

def shell_apps
  json_file = File.read(SHELL_APPS_FILE)
  parsed = JSON.parse(json_file, symbolize_names: true)
  parsed[:apps]
end

def install_shell_apps
  section_header "Installing shell apps"

  shell_apps.each do |app|
    install_shell_app(
      name: app[:name],
      test: app[:test],
      command: app[:command]
    )
  end
  section_footer "Done installing shell apps"
end

def install_brew_apps
  section_header "Installing Brew and App Store apps"
  
  # Install regular apps first (no sudo required)
  pprint "Installing apps that don't require sudo...", style: :bold, indent: 1
  regular_success = system("brew bundle --file=data/Brewfile")
  
  if regular_success
    pprint "‚úÖ Regular apps installed successfully!", style: :bold, color: :green, indent: 1
  else
    pprint "‚ö†Ô∏è Some regular apps failed to install", style: :bold, color: :yellow, indent: 1
  end
  
  # Install sudo-requiring apps with askpass helper
  if File.exist?("data/Brewfile_needs_sudo")
    # Check if sudo apps are already installed using brew bundle check
    if system("brew bundle check --file=data/Brewfile_needs_sudo > /dev/null 2>&1")
      pprint "‚úÖ All admin-required apps already installed!", style: :bold, color: :green, indent: 1
    else
      pprint "Installing apps that require admin password...", style: :bold, indent: 1
      
      # Set up askpass helper for sudo prompts
      askpass_script = File.join(Dir.pwd, "bin", "askpass_helper")
      ENV['SUDO_ASKPASS'] = askpass_script
      
      # Pre-authenticate sudo to cache credentials
      if system("sudo -A true")
        sudo_success = system("brew bundle --file=data/Brewfile_needs_sudo")
        
        if sudo_success
          pprint "‚úÖ Admin-required apps installed successfully!", style: :bold, color: :green, indent: 1
        else
          pprint "‚ö†Ô∏è Some admin-required apps failed to install", style: :bold, color: :yellow, indent: 1
        end
      else
        pprint "‚ùå Admin authentication cancelled - skipping sudo apps", style: :bold, color: :red, indent: 1
        pprint "You can install them manually later with: brew bundle --file=data/Brewfile_needs_sudo", style: :italic, indent: 2
      end
    end
  end
  
  section_footer "Done installing Brew and App Store apps"
end

def install_apps
  install_shell_apps
  install_brew_apps
end

install_apps