#!/usr/bin/env ruby

require_relative '../lib/terminal_helpers'

# Path constants
DOCUMENTS_PATH = "~/Documents"
SCREEN_SHOTS_PATH = "~/screenshots"
ICLOUD_SYMLINK_PATH = "~/iCloud"
ICLOUD_SOURCE_PATH = "~/Library/Mobile Documents/com~apple~CloudDocs"

# Individual folder name constants
FOLDER_AUTO = "@auto"
FOLDER_INBOX = "000_Inbox"
FOLDER_PEOPLE = "100_People"
FOLDER_TIME = "200_Time"
FOLDER_AREAS = "300_Areas"
FOLDER_GOALS = "320_Goals"
FOLDER_PROJECTS = "330_Projects"
FOLDER_TOPICS = "400_Topics"
FOLDER_LIBRARIES = "700_Libraries"
FOLDER_OUTPUT = "900_Output"
FOLDER_STORIES = "910_Stories"
FOLDER_WORKSPACE = "950_Workspace"
FOLDER_META = "950_Workspace"

# Folder names array
ESSENTIAL_FOLDERS = [
  FOLDER_AUTO,
  FOLDER_INBOX,
  FOLDER_PEOPLE,
  FOLDER_TIME,
  FOLDER_AREAS,
  FOLDER_GOALS,
  FOLDER_PROJECTS,
  FOLDER_TOPICS,
  FOLDER_LIBRARIES,
  FOLDER_OUTPUT,
  FOLDER_STORIES,
  FOLDER_META
]

# Section titles
FOLDERS_HEADER = "Creating Essential Folders"
FOLDERS_FOOTER = "Essential folders are ready"
SYMLINKS_HEADER = "Creating Essential Symlinks"
SYMLINKS_FOOTER = "Essential symlinks are ready"

section_header(FOLDERS_HEADER)

home_documents = File.expand_path(DOCUMENTS_PATH)

pputs "Creating #{ESSENTIAL_FOLDERS.length} essential folders", indent: 1

# Create each folder if it doesn't exist
ESSENTIAL_FOLDERS.each do |folder_name|
  folder_path = File.join(home_documents, folder_name)
  
  if File.directory?(folder_path)
    pprint "#{folder_name}", indent: 1
    print_column_fill("    #{folder_name}", indent: 1, color: :green)
    pputs " exists", color: :green
  else
    Dir.mkdir(folder_path)
    pprint "#{folder_name}", indent: 1
    print_column_fill("    #{folder_name}", indent: 1, color: :green)
    pputs " created", color: :green
  end
end

# Create Screen Shots folder in home directory
screen_shots_path = File.expand_path(SCREEN_SHOTS_PATH)

if File.directory?(screen_shots_path)
  pprint "Screen Shots", indent: 1
  print_column_fill("    Screen Shots", indent: 1, color: :green)
  pputs " exists", color: :green
else
  Dir.mkdir(screen_shots_path)
  pprint "Screen Shots", indent: 1
  print_column_fill("    Screen Shots", indent: 1, color: :green)
  pputs " created", color: :green
end

section_footer(FOLDERS_FOOTER)

section_header(SYMLINKS_HEADER)


# Create iCloud Drive symlink
icloud_source = File.expand_path(ICLOUD_SOURCE_PATH)
icloud_symlink = File.expand_path(ICLOUD_SYMLINK_PATH)

if File.symlink?(icloud_symlink)
  if File.readlink(icloud_symlink) == icloud_source
    pprint "~/iCloud", indent: 1
    print_column_fill("    ~/iCloud", indent: 1, color: :green)
    pputs " exists", color: :green
  else
    # Remove incorrect symlink and create new one
    File.unlink(icloud_symlink)
    File.symlink(icloud_source, icloud_symlink)
    pprint "~/iCloud", indent: 1
    print_column_fill("    ~/iCloud", indent: 1, color: :green)
    pputs " updated", color: :green
  end
elsif File.exist?(icloud_symlink)
  pputs "Warning: ~/iCloud exists but is not a symlink", indent: 1, color: :yellow
else
  File.symlink(icloud_source, icloud_symlink)
  pprint "~/iCloud", indent: 1
  print_column_fill("    ~/iCloud", indent: 1, color: :green)
  pputs " created", color: :green
end

section_footer(SYMLINKS_FOOTER)