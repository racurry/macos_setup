#!/usr/bin/env bash
# asdf-nuke: Remove a package from asdf management entirely
# Usage: asdf-nuke <package-name>

set -euo pipefail

if [[ $# -eq 0 ]]; then
    echo "Usage: asdf-nuke <package-name>"
    echo ""
    echo "Removes a package from asdf management by:"
    echo "  1. Removing it as an asdf plugin (if exists)"
    echo "  2. Uninstalling it from npm globals (all nodejs versions)"
    echo "  3. Uninstalling it from pip (all python versions)"
    echo "  4. Uninstalling it from gems (all ruby versions)"
    echo "  5. Removing the shim file"
    echo "  6. Reshimming asdf"
    echo ""
    echo "Example: asdf-nuke claude"
    exit 1
fi

PACKAGE="$1"
SHIM_PATH="$HOME/.asdf/shims/$PACKAGE"

echo "üî• Nuking '$PACKAGE' from asdf management..."
echo ""

# 1. Remove asdf plugin if it exists
echo "üì¶ Checking for asdf plugin..."
if asdf plugin list | grep -q "^${PACKAGE}$"; then
    echo "  ‚Üí Removing asdf plugin: $PACKAGE"
    asdf plugin remove "$PACKAGE" 2>/dev/null || echo "  ‚ö†Ô∏è  Failed to remove plugin (may not exist)"
else
    echo "  ‚úì No asdf plugin found for $PACKAGE"
fi

# 2. Remove from npm globals (all nodejs versions)
echo ""
echo "üì¶ Checking npm globals across all nodejs versions..."
if asdf plugin list 2>/dev/null | grep -q "^nodejs$"; then
    NODEJS_VERSIONS=$(asdf list nodejs 2>/dev/null | sed 's/^[* ]*//')
    if [[ -n "$NODEJS_VERSIONS" ]]; then
        while IFS= read -r version; do
            [[ -z "$version" ]] && continue  # Skip empty lines
            NPM_BIN="$HOME/.asdf/installs/nodejs/$version/bin/npm"
            BIN_PATH="$HOME/.asdf/installs/nodejs/$version/bin/$PACKAGE"

            # Check if binary exists in this nodejs version's bin directory
            if [[ -e "$BIN_PATH" ]]; then
                echo "  ‚Üí Found binary in nodejs $version, attempting uninstall"
                # Try to find and uninstall the owning package
                # The binary might be a symlink to the actual package
                if [[ -L "$BIN_PATH" ]]; then
                    TARGET=$(readlink "$BIN_PATH")
                    # Extract package name from path like ../lib/node_modules/@scope/package/...
                    if [[ "$TARGET" =~ node_modules/(@[^/]+/[^/]+|[^/]+) ]]; then
                        PKG_NAME="${BASH_REMATCH[1]}"
                        echo "    Detected package: $PKG_NAME"
                        ASDF_NODEJS_VERSION=$version "$NPM_BIN" uninstall -g "$PKG_NAME" 2>&1 | grep -v "warn Unknown" || true
                    fi
                fi
            fi
        done <<< "$NODEJS_VERSIONS"
        echo "  ‚úì Checked all nodejs versions"
    else
        echo "  ‚úì No nodejs versions installed"
    fi
else
    echo "  ‚úì nodejs plugin not installed"
fi

# 3. Remove from pip (all python versions)
echo ""
echo "üì¶ Checking pip across all python versions..."
if asdf plugin list 2>/dev/null | grep -q "^python$"; then
    PYTHON_VERSIONS=$(asdf list python 2>/dev/null | sed 's/^[* ]*//')
    if [[ -n "$PYTHON_VERSIONS" ]]; then
        while IFS= read -r version; do
            [[ -z "$version" ]] && continue  # Skip empty lines
            PIP_BIN="$HOME/.asdf/installs/python/$version/bin/pip"
            # Force this specific python version to avoid .tool-versions interference
            # Use pip show to reliably check if package is installed
            if [[ -x "$PIP_BIN" ]] && ASDF_PYTHON_VERSION=$version "$PIP_BIN" show "$PACKAGE" >/dev/null 2>&1; then
                echo "  ‚Üí Uninstalling from python $version: $PACKAGE"
                ASDF_PYTHON_VERSION=$version "$PIP_BIN" uninstall -y "$PACKAGE" || echo "  ‚ö†Ô∏è  Failed to uninstall from python $version"
            fi
        done <<< "$PYTHON_VERSIONS"
        echo "  ‚úì Checked all python versions"
    else
        echo "  ‚úì No python versions installed"
    fi
else
    echo "  ‚úì python plugin not installed"
fi

# 4. Remove from gems (all ruby versions)
echo ""
echo "üì¶ Checking gems across all ruby versions..."
if asdf plugin list 2>/dev/null | grep -q "^ruby$"; then
    RUBY_VERSIONS=$(asdf list ruby 2>/dev/null | sed 's/^[* ]*//')
    if [[ -n "$RUBY_VERSIONS" ]]; then
        while IFS= read -r version; do
            [[ -z "$version" ]] && continue  # Skip empty lines
            GEM_BIN="$HOME/.asdf/installs/ruby/$version/bin/gem"
            # Force this specific ruby version to avoid .tool-versions interference
            # Use gem info to check if gem is installed (exits 0 if found, 1 if not)
            if [[ -x "$GEM_BIN" ]] && ASDF_RUBY_VERSION=$version "$GEM_BIN" info "$PACKAGE" >/dev/null 2>&1; then
                echo "  ‚Üí Uninstalling from ruby $version: $PACKAGE"
                ASDF_RUBY_VERSION=$version "$GEM_BIN" uninstall -ax "$PACKAGE" || echo "  ‚ö†Ô∏è  Failed to uninstall from ruby $version"
            fi
        done <<< "$RUBY_VERSIONS"
        echo "  ‚úì Checked all ruby versions"
    else
        echo "  ‚úì No ruby versions installed"
    fi
else
    echo "  ‚úì ruby plugin not installed"
fi

# 5. Remove shim file directly
echo ""
echo "üîó Checking for shim..."
if [[ -f "$SHIM_PATH" ]]; then
    echo "  ‚Üí Removing shim: $SHIM_PATH"
    rm -f "$SHIM_PATH"
    echo "  ‚úì Shim removed"
else
    echo "  ‚úì No shim found at $SHIM_PATH"
fi

# 5. Reshim all asdf plugins
echo ""
echo "üîÑ Reshimming asdf..."
asdf reshim 2>/dev/null || echo "  ‚ö†Ô∏è  Reshim failed (this is usually fine)"

echo ""
echo "‚úÖ Done! '$PACKAGE' has been nuked from asdf."
echo ""
echo "If the shim reappears, check:"
echo "  ‚Ä¢ asdf plugin list"
echo "  ‚Ä¢ npm list -g --depth=0"
echo "  ‚Ä¢ pip list"
echo "  ‚Ä¢ gem list"
