#!/usr/bin/env ruby
require 'fileutils'
require 'shellwords'

IGNORED_FILES = %w{.DS_Store .. .}

def show_help
  puts <<~EOF
Usage: #{File.basename($0)} [OPTIONS] FILE_OR_DIRECTORY

Convert AVI files to MP4 format using ffmpeg.

ARGUMENTS:
  FILE_OR_DIRECTORY    Single AVI file or directory containing AVI files

OPTIONS:
  -h, --help          Show this help message and exit

DESCRIPTION:
  This script converts AVI video files to MP4 format using ffmpeg with
  codec copy (no re-encoding). It can process a single file or all AVI
  files in a directory.

  Requires ffmpeg.

EXAMPLES:
  #{File.basename($0)} video.avi
  #{File.basename($0)} ~/Videos/

EOF
end

def convert_file(file)
  file_name_with_no_extension = file.split('.')[0...-1].join('.')

  avi_file = "#{file_name_with_no_extension}.avi"
  mp4_file = "#{file_name_with_no_extension}.mp4"

  unless File.exists?(avi_file)
    puts "Error: Could not find AVI file: #{avi_file}"
    return false
  end

  if File.exists?(mp4_file)
    puts "Skipping #{File.basename(avi_file)} - MP4 already exists"
    return true
  end

  puts "Converting #{File.basename(avi_file)}..."
  escaped_avi = Shellwords.escape(avi_file)
  escaped_mp4 = Shellwords.escape(mp4_file)
  command = "ffmpeg -i #{escaped_avi} -codec copy #{escaped_mp4}"
  
  success = system(command)
  unless success
    puts "Error: Failed to convert #{File.basename(avi_file)}"
  end
  
  success
end

def convert_file_or_folder_of_files(file_or_folder_name)
  unless File.exists?(file_or_folder_name)
    puts "Error: No such file or directory: #{file_or_folder_name}"
    exit 1
  end

  is_directory = File.directory?(file_or_folder_name)

  files_to_convert = if is_directory
                        all_files = Dir.entries(file_or_folder_name)
                        good_files = all_files - IGNORED_FILES
                        avi_files = good_files.select { |f| f.downcase.end_with?('.avi') }
                        avi_files.map { |x| "#{file_or_folder_name}/#{x}" }
                      else
                        [file_or_folder_name]
                      end

  if files_to_convert.empty?
    puts "No AVI files found to convert"
    return
  end

  puts "Found #{files_to_convert.length} AVI file(s) to convert"
  success_count = 0
  
  files_to_convert.each do |file|
    if convert_file(File.realpath(file))
      success_count += 1
    end
  end
  
  puts "Successfully converted #{success_count}/#{files_to_convert.length} files"
end

# Parse command line arguments
if ARGV.include?('-h') || ARGV.include?('--help')
  show_help
  exit 0
end

if ARGV.empty?
  puts "Error: No file or directory specified"
  puts ""
  show_help
  exit 1
end

convert_file_or_folder_of_files(ARGV.first)