#!/usr/bin/env bash
# npm-fix: Clean up stale npm temp directories that cause ENOTEMPTY errors
#
# When npm install is interrupted (Ctrl+C, crash, etc.), it can leave behind
# temp directories like .package-name-XYZ that prevent future installs.
# This script finds and removes them.

set -euo pipefail

echo "üîç Searching for stale npm temp directories..."

FOUND=0

# Find hidden directories with random suffixes (npm's temp rename pattern)
# Only match directories older than 5 minutes to avoid killing active installs
while IFS= read -r dir; do
    if [[ -n "$dir" ]]; then
        echo "  ‚Üí Removing: $dir"
        rm -rf "$dir"
        ((FOUND++)) || true
    fi
done < <(find ~/.asdf/installs/nodejs/*/lib/node_modules -maxdepth 2 -type d -name ".*-*" -mmin +5 2>/dev/null || true)

# Also check for common problematic patterns
while IFS= read -r dir; do
    if [[ -n "$dir" ]]; then
        echo "  ‚Üí Removing: $dir"
        rm -rf "$dir"
        ((FOUND++)) || true
    fi
done < <(find ~/.asdf/installs/nodejs/*/lib/node_modules -maxdepth 2 -type d -name ".staging" -mmin +5 2>/dev/null || true)

if [[ $FOUND -eq 0 ]]; then
    echo "‚úì No stale temp directories found"
else
    echo ""
    echo "‚úÖ Cleaned up $FOUND stale directory(s)"
    echo ""
    echo "You can now retry your npm install."
fi
